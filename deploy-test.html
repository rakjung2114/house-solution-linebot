<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Deploy & Test LINE Bot</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .step { border: 2px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 10px; }
        .step.active { border-color: #007bff; background-color: #f8f9fa; }
        .step.success { border-color: #28a745; background-color: #d4edda; }
        .step.error { border-color: #dc3545; background-color: #f8d7da; }
        .btn { padding: 12px 25px; margin: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .result { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; }
        .result.show { display: block; }
        .code { background-color: #f1f1f1; padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0; }
        .highlight { background-color: yellow; padding: 2px 4px; }
    </style>
</head>
<body>
    <h1>üöÄ LINE Bot Deploy & Test Guide</h1>
    <p>‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ deploy ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Bot</p>

    <!-- Step 1: Deploy Web App -->
    <div id="step1" class="step active">
        <h2>1Ô∏è‚É£ Deploy Web App ‡πÉ‡∏´‡∏°‡πà</h2>
        <p><strong>‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏ô Google Apps Script Editor:</strong></p>
        <ol>
            <li>‡πÄ‡∏õ‡∏¥‡∏î <a href="https://script.google.com" target="_blank">Google Apps Script</a></li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</li>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å <span class="highlight">Deploy</span> ‚Üí <span class="highlight">New deployment</span></li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Type: <span class="highlight">Web app</span></li>
            <li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</li>
            <ul>
                <li>Execute as: <span class="highlight">Me</span></li>
                <li>Who has access: <span class="highlight">Anyone</span></li>
            </ul>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å <span class="highlight">Deploy</span></li>
            <li>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Web app URL (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)</li>
        </ol>
        <button class="btn btn-primary" onclick="testDeployment()">Test Deployment</button>
        <div id="step1Result" class="result"></div>
    </div>

    <!-- Step 2: Test Basic Functions -->
    <div id="step2" class="step">
        <h2>2Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
        <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Web App ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        <button class="btn btn-primary" onclick="testBasicFunctions()">Test Basic Functions</button>
        <div id="step2Result" class="result"></div>
    </div>

    <!-- Step 3: Test LINE Bot Token -->
    <div id="step3" class="step">
        <h2>3Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Bot Token</h2>
        <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LINE Channel Access Token ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>
        <button class="btn btn-primary" onclick="testLineToken()">Test LINE Token</button>
        <div id="step3Result" class="result"></div>
    </div>

    <!-- Step 4: Setup Webhook -->
    <div id="step4" class="step">
        <h2>4Ô∏è‚É£ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE Bot Webhook</h2>
        <p><strong>‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏ô LINE Developers Console:</strong></p>
        <ol>
            <li>‡πÄ‡∏õ‡∏¥‡∏î <a href="https://developers.line.biz/console/" target="_blank">LINE Developers Console</a></li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Channel ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</li>
            <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <span class="highlight">Messaging API settings</span></li>
            <li>‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Webhook settings:</li>
            <ul>
                <li>Webhook URL: <input type="text" id="webhookUrl" placeholder="‡πÉ‡∏™‡πà Web App URL" style="width: 300px;"></li>
                <li>Use webhook: <span class="highlight">‡πÄ‡∏õ‡∏¥‡∏î (ON)</span></li>
            </ul>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å <span class="highlight">Verify</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</li>
        </ol>
        <button class="btn btn-success" onclick="copyUrlToClipboard()">Copy URL to Clipboard</button>
        <button class="btn btn-primary" onclick="testWebhookSetup()">Test Webhook</button>
        <div id="step4Result" class="result"></div>
    </div>

    <!-- Step 5: Test Message -->
    <div id="step5" class="step">
        <h2>5Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
        <p>‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å LINE</p>
        <input type="text" id="testMsg" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏î‡∏™‡∏≠‡∏ö, ‡πÄ‡∏°‡∏ô‡∏π)" style="width: 300px; padding: 8px;">
        <button class="btn btn-warning" onclick="simulateLineMessage()">Simulate Message</button>
        <div id="step5Result" class="result"></div>
    </div>

    <!-- Final Test -->
    <div id="finalTest" class="step">
        <h2>üéØ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</h2>
        <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Bot ‡∏à‡∏£‡∏¥‡∏á</p>
        <div class="code">
            ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô LINE Bot:<br>
            ‚Ä¢ <strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö</strong> - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô<br>
            ‚Ä¢ <strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</strong> - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢<br>
            ‚Ä¢ <strong>‡πÄ‡∏°‡∏ô‡∏π</strong> - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å<br>
            ‚Ä¢ <strong>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</strong> - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        </div>
        <button class="btn btn-success" onclick="runFullTest()">Run Full System Test</button>
        <div id="finalResult" class="result"></div>
    </div>

    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö URL
        let webappUrl = '';

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function showResult(elementId, success, message, data = '') {
            const div = document.getElementById(elementId);
            div.className = `result show ${success ? 'success' : 'error'}`;
            div.style.backgroundColor = success ? '#d4edda' : '#f8d7da';
            div.style.color = success ? '#155724' : '#721c24';
            div.innerHTML = `
                <strong>${success ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'}</strong><br>
                ${message}
                ${data ? `<br><small>${data}</small>` : ''}
            `;

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
            const step = document.getElementById(elementId.replace('Result', ''));
            step.className = `step ${success ? 'success' : 'error'}`;
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ deploy
        async function testDeployment() {
            try {
                // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                webappUrl = window.location.href.split('?')[0];
                
                const response = await fetch(webappUrl);
                const text = await response.text();
                
                if (response.ok) {
                    document.getElementById('webhookUrl').value = webappUrl;
                    showResult('step1Result', true, 'Web App deployment ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ!', `Response: ${text}`);
                } else {
                    showResult('step1Result', false, 'Web App ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', `Status: ${response.status}`);
                }
            } catch (error) {
                showResult('step1Result', false, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Web App ‡πÑ‡∏î‡πâ', error.message);
            }
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        async function testBasicFunctions() {
            try {
                const response = await fetch(webappUrl + '?action=getWebAppInfo');
                const result = await response.json();
                
                if (result.success) {
                    webappUrl = result.data.webappUrl;
                    document.getElementById('webhookUrl').value = webappUrl;
                    showResult('step2Result', true, '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ!', `Script ID: ${result.data.scriptId}`);
                } else {
                    showResult('step2Result', false, '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', result.error);
                }
            } catch (error) {
                showResult('step2Result', false, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', error.message);
            }
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Token
        async function testLineToken() {
            try {
                const response = await fetch(webappUrl + '?action=testLineBotConnection');
                const result = await response.json();
                
                if (result.success) {
                    showResult('step3Result', true, 'LINE Token ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ!', `Bot: ${result.data.displayName} (${result.data.botId})`);
                } else {
                    showResult('step3Result', false, 'LINE Token ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', result.message);
                }
            } catch (error) {
                showResult('step3Result', false, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Token ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', error.message);
            }
        }

        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL
        function copyUrlToClipboard() {
            const urlInput = document.getElementById('webhookUrl');
            urlInput.select();
            document.execCommand('copy');
            alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß! ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô LINE Developers Console');
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Webhook
        async function testWebhookSetup() {
            try {
                const testEvent = { events: [] }; // Empty events for webhook test
                
                const response = await fetch(webappUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testEvent)
                });
                
                const result = await response.text();
                
                if (response.ok) {
                    showResult('step4Result', true, 'Webhook setup ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!', `Response: ${result}`);
                } else {
                    showResult('step4Result', false, 'Webhook setup ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', `Status: ${response.status}`);
                }
            } catch (error) {
                showResult('step4Result', false, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Webhook ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', error.message);
            }
        }

        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE
        async function simulateLineMessage() {
            const message = document.getElementById('testMsg').value.trim();
            if (!message) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                return;
            }

            const lineEvent = {
                events: [{
                    type: 'message',
                    message: { type: 'text', text: message },
                    source: { userId: 'test-user-' + Date.now() },
                    replyToken: 'test-reply-' + Date.now()
                }]
            };

            try {
                const response = await fetch(webappUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(lineEvent)
                });
                
                const result = await response.text();
                
                if (response.ok) {
                    showResult('step5Result', true, '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß!', `Response: ${result}`);
                } else {
                    showResult('step5Result', false, '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', `Status: ${response.status}`);
                }
            } catch (error) {
                showResult('step5Result', false, '‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', error.message);
            }
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function runFullTest() {
            try {
                const response = await fetch(webappUrl + '?action=testBotSystem');
                const result = await response.json();
                
                if (result.success) {
                    showResult('finalResult', true, '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô!', 
                        `Token: ${result.data.channelToken ? '‚úÖ' : '‚ùå'} | 
                         Spreadsheet: ${result.data.spreadsheet ? '‚úÖ' : '‚ùå'} | 
                         Menu: ${result.data.flexMenu ? '‚úÖ' : '‚ùå'}`);
                } else {
                    showResult('finalResult', false, '‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', result.message);
                }
            } catch (error) {
                showResult('finalResult', false, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', error.message);
            }
        }

        // Auto-start on page load
        window.onload = function() {
            console.log('Deploy & Test page loaded');
            // testDeployment();
        };
    </script>
</body>
</html>
