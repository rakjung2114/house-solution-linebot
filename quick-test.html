<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Bot Quick Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-box { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ü§ñ LINE Bot Quick Test</h1>
    
    <div class="test-box info">
        <h3>üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
        <ol>
            <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Get Web App URL" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π URL ‡∏Ç‡∏≠‡∏á Web App</li>
            <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Test Channel Token" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Bot Token</li>
            <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Simulate Message" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>
            <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console Log ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
        </ol>
    </div>

    <div class="test-box">
        <h3>üîó Web App Information</h3>
        <button onclick="getWebAppURL()">Get Web App URL</button>
        <div id="urlResult"></div>
    </div>

    <div class="test-box">
        <h3>üîë LINE Channel Token Test</h3>
        <button onclick="testChannelToken()">Test Channel Token</button>
        <div id="tokenResult"></div>
    </div>

    <div class="test-box">
        <h3>üí¨ Message Simulation</h3>
        <input type="text" id="testMessage" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏ô‡∏π)" style="width: 300px; padding: 5px;">
        <button onclick="simulateMessage()">Simulate Message</button>
        <div id="messageResult"></div>
    </div>

    <div class="test-box">
        <h3>üìä System Status</h3>
        <button onclick="fullSystemTest()">Full System Test</button>
        <div id="systemResult"></div>
    </div>

    <div class="test-box">
        <h3>üìã Console Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log" class="log">Ready...<br></div>
    </div>

    <script>
        // ‡πÉ‡∏ä‡πâ URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô domain ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Web App
        const WEBAPP_URL = window.location.href.split('?')[0];
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...<br>';
        }

        function showResult(elementId, type, message) {
            const div = document.getElementById(elementId);
            div.className = 'test-box ' + type;
            div.innerHTML = message;
        }

        async function getWebAppURL() {
            log('Getting Web App URL...');
            try {
                const response = await fetch(WEBAPP_URL + '?action=getWebAppInfo');
                const result = await response.json();
                
                if (result.success) {
                    showResult('urlResult', 'success', `
                        <strong>‚úÖ Web App URL:</strong><br>
                        <input type="text" value="${result.data.webappUrl}" readonly style="width: 100%; margin-top: 5px;">
                        <br><small>Script ID: ${result.data.scriptId}</small>
                    `);
                    log('‚úÖ Web App URL retrieved successfully');
                } else {
                    showResult('urlResult', 'error', '‚ùå Failed to get Web App URL: ' + result.error);
                    log('‚ùå Failed to get Web App URL');
                }
            } catch (error) {
                showResult('urlResult', 'error', '‚ùå Error: ' + error.message);
                log('‚ùå Error getting Web App URL: ' + error.message);
            }
        }

        async function testChannelToken() {
            log('Testing LINE Channel Token...');
            try {
                const response = await fetch(WEBAPP_URL + '?action=testLineBotConnection');
                const result = await response.json();
                
                if (result.success) {
                    showResult('tokenResult', 'success', `
                        <strong>‚úÖ LINE Bot Connected!</strong><br>
                        Bot ID: ${result.data.botId}<br>
                        Display Name: ${result.data.displayName}
                    `);
                    log('‚úÖ LINE Channel Token is valid');
                } else {
                    showResult('tokenResult', 'error', '‚ùå LINE Bot Connection Failed: ' + result.message);
                    log('‚ùå LINE Channel Token test failed: ' + result.message);
                }
            } catch (error) {
                showResult('tokenResult', 'error', '‚ùå Error: ' + error.message);
                log('‚ùå Error testing channel token: ' + error.message);
            }
        }

        async function simulateMessage() {
            const message = document.getElementById('testMessage').value.trim();
            if (!message) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                return;
            }

            log(`Simulating message: "${message}"`);
            
            const webhookEvent = {
                events: [{
                    type: 'message',
                    message: {
                        type: 'text',
                        text: message
                    },
                    source: {
                        userId: 'test-user-' + Date.now()
                    },
                    replyToken: 'test-reply-token-' + Date.now()
                }]
            };

            try {
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(webhookEvent)
                });
                
                const result = await response.text();
                
                if (response.ok) {
                    showResult('messageResult', 'success', `
                        <strong>‚úÖ Message Processed!</strong><br>
                        Status: ${response.status}<br>
                        Response: ${result}
                    `);
                    log('‚úÖ Message simulation successful');
                } else {
                    showResult('messageResult', 'error', `
                        <strong>‚ùå Message Failed!</strong><br>
                        Status: ${response.status}<br>
                        Response: ${result}
                    `);
                    log('‚ùå Message simulation failed: ' + response.status);
                }
            } catch (error) {
                showResult('messageResult', 'error', '‚ùå Error: ' + error.message);
                log('‚ùå Message simulation error: ' + error.message);
            }
        }

        async function fullSystemTest() {
            log('Running full system test...');
            try {
                const response = await fetch(WEBAPP_URL + '?action=testBotSystem');
                const result = await response.json();
                
                if (result.success) {
                    showResult('systemResult', 'success', `
                        <strong>‚úÖ System Test Passed!</strong><br>
                        Channel Token: ${result.data.channelToken ? '‚úÖ' : '‚ùå'}<br>
                        Spreadsheet: ${result.data.spreadsheet ? '‚úÖ' : '‚ùå'}<br>
                        Flex Menu: ${result.data.flexMenu ? '‚úÖ' : '‚ùå'}
                        ${result.data.errors.length > 0 ? '<br><br><strong>Errors:</strong><br>' + result.data.errors.join('<br>') : ''}
                    `);
                    log('‚úÖ Full system test completed');
                } else {
                    showResult('systemResult', 'error', '‚ùå System Test Failed: ' + result.message);
                    log('‚ùå System test failed: ' + result.message);
                }
            } catch (error) {
                showResult('systemResult', 'error', '‚ùå Error: ' + error.message);
                log('‚ùå System test error: ' + error.message);
            }
        }

        // Auto-run basic test on page load
        window.onload = function() {
            log('Quick Test page loaded');
            log('Current URL: ' + WEBAPP_URL);
            getWebAppURL();
        };
    </script>
</body>
</html>
